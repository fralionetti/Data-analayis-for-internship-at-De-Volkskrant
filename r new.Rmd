---
title: "FOSSIL FUEL SUBSIDIES FINAL"
output: pdf_document
  beamer_presentation: default
  ioslides_presentation: default
date: "2023-11-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(repos = "http://cran.us.r-project.org")
install.packages('tinytex')
install.packages("weatherData",repos = "http://cran.us.r-project.org")
install.packages("gridExtra")
library(gridExtra)
install.packages("ggrepel")
library(ggrepel)

```

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## cREATING A SUBDATASET        
First of all, I read the IMF dataet and I create a subdataset keeping only the variables that I need and creating the new ones. 

To avoid scientific notation

```{r cars, echo = TRUE}
options(scipen=999)
```

I install and read the ecesary packages

```{r pressureSS}
install.packages(c("tidyverse", "readxl"))
library(tidyverse)
library(readxl)
install.packages("plotly")
library(ggplot2)
library(dplyr)
library(forcats)
```

Now, I read the file: I Specify the file path and the sheet name that IO want to open

```{r 2}
excel_file <- "C:/Users/lionet000/Downloads/external-fuel-subsidies-template-2023-10-02 (2).xlsx"
sheet_name <- "data"
IMF_data <- read_excel(excel_file, sheet = sheet_name)


```

Now, I select only the columns that I want to keep and I select only unique rows (unique values) as the same values are repeated twice

```{r pressure3}
IMF_subdata<-IMF_data %>% 
  select(countryname, countrycode, region, year, Global_warming=mit.sub.glow.tot.all.1, mit_exrate, mit.pop.mn, mit.gdp.pre.lvl.1,
         Explicit_subsidies=mit.sub.texp.tot.all.1, Implicit_subsidies=mit.sub.timp.tot.all.1, mit.co2.tot.1, Total_subsidies=mit.sub.tot.tot.all.1)

IMF_subdata_distinct<-IMF_subdata %>% 
  distinct() 
```

```{r pressure3}

columns_to_check <- c(
  'countryname', 'countrycode', 'region', 'year', 'mit.sub.glow.tot.all.1', 'mit_exrate', 'mit.pop.mn', 'mit.gdp.pre.lvl.1', 'mit.sub.texp.tot.all.1', 'mit.sub.timp.tot.all.1', 'mit.co2.tot.1', 'mit.sub.tot.tot.all.1'
)

# Check if there are any 0 values in the specified columns
zero_values <- sapply(IMF_data[columns_to_check], function(col) any(col == 0))

# Print the result
print(zero_values)
```

#Now, I create the the new variables that I need: first I transform the climate change, explicit, implicit and total subsidies variables into billions and then I divide them per GDP. The I create one variable including both the explicit subsidies and the climate changte cost also a a share of GDP
```{r pressure5}

#first, I ensure that the mit.co2.tot.1 is numeric
IMF_subdata_distinct$mit.co2.tot.1 <- as.numeric(IMF_subdata_distinct$mit.co2.tot.1)

#now, I change the vriables
IMF_newdata <- IMF_subdata_distinct %>%
  mutate(climatechange_billions = Global_warming / 1000,
         climatechange_GDP = (climatechange_billions / mit.gdp.pre.lvl.1) * 100,
         explicitsubidies_billions = Explicit_subsidies / 1000,
         explicitsubidies_GDP = (explicitsubidies_billions / mit.gdp.pre.lvl.1) * 100,
         implicitsubidies_billions = Implicit_subsidies / 1000,
         implicitsubidies_GDP = (implicitsubidies_billions / mit.gdp.pre.lvl.1) * 100,
         totalsubidies_billions = Total_subsidies / 1000,
         totalsubidies_GDP = (totalsubidies_billions / mit.gdp.pre.lvl.1) * 100,
         climatechange_explicit_billions = explicitsubidies_billions + climatechange_billions,
         climatechange_explicit_GDP = ((climatechange_billions + explicitsubidies_billions) / mit.gdp.pre.lvl.1) * 100,
         consumpion_billions = mit.co2.tot.1 /1000,
         average_cost_explicit_climatechange = climatechange_explicit_billions / consumpion_billions,
         average_cost_climatechange = climatechange_billions / consumpion_billions,
         average_cost_explicit = explicitsubidies_billions / consumpion_billions
         )

head(IMF_newdata)

write.csv(IMF_newdata, "C:/Users/lionet000/Documents/fossil fuels/IMF_newdata.csv", row.names = FALSE)
```

I look at 2 exaples to double-check that the results are good: Italy in 2015 and the Netherlands in 2022
```{r pressure7}
examples <- IMF_newdata %>%
  filter((countryname == "Netherlands" & year == 2022) | (countryname == "Italy" & year == 2015))
View(examples)
```


## MAKING THE GRAPHS - the situation in the world

Firt, I look at how the situation is in the world
I create a dataset with the explicit + implicit subsidy and I use it to create a world map with these values in datawrapper
```{r pressure6}
formap_total<- IMF_newdata %>%
  filter(year== 2022) %>% 
  select(countrycode, climatechange_explicit_GDP) %>%
  mutate(climatechange_explicit_GDP = round(climatechange_explicit_GDP, 1))

#I copy the data to the clipboard so that I can copy them directly in datawrapper
formap_total %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)
```


Now, I create a horizontal bar chart with the 20 countries woth the most avwerage subidies (climate change cost + explicit) between 2015 and 2022
```{r pressure8}
start_year <- 2015
end_year <- 2022

data_2015_2022 <- IMF_newdata %>%
  filter(year >= start_year, year <= end_year) 

top20_data_world <- data_2015_2022 %>%
  group_by(countryname) %>%
  summarize(avg_climatechange_explicit_GDP_country = mean(climatechange_explicit_GDP, na.rm = TRUE)) %>%
  arrange(desc(avg_climatechange_explicit_GDP_country)) %>%
  head(20)

horizontalbarchart_top20_world <- ggplot(top20_data_world) +
  geom_col(aes(x = reorder(countryname, avg_climatechange_explicit_GDP_country), y = avg_climatechange_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Top 20 Countries by Average subsidies as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change and explicit subsidies") +
  coord_flip()

horizontalbarchart_top20_world

```
Now, I look at the top 20 countries in 2022. This time, however, I look at the difference between the explicit subsidy and the climate change subsidy
```{r pressure37}
stacked_data <- data_2015_2022 %>%
  filter(year == 2022) %>%
  select(countryname, climatechange_GDP, explicitsubidies_GDP) %>%
  rename(
    Category = countryname,
    Value1 = climatechange_GDP,
    Value2 = explicitsubidies_GDP
  )
top_countries <- stacked_data %>%
  arrange(desc(Value1 + Value2)) %>%  # Arrange in descending order based on the sum of Value1 and Value2
  head(20)

# Reshape the data
data_long <- tidyr::gather(top_countries, key = "Variable", value = "Value", -Category)

# Create a horizontal stacked bar chart
stacked_barchart_top20 <- ggplot(data_long, aes(y = Category, x = Value, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Fossil Fuel subsidies in the top 20 countries in 2022",
       y = "Country",
       x = "Fossil fuel subsidies",
       fill = "legend") +
  scale_fill_manual(values = c("Value1" = "blue", "Value2" = "red"),
                    name = "Type of Subsidy",
                    labels = c("Value1" = "Climate change subsidy", "Value2" = "Explicit subsidy"))


stacked_barchart_top20
```

ow, I create the same stacked bar chart, but looking at the explicit and climate change subsidies divided by the total CO2 emitted by the country
```{r pressure337}
stacked_data2 <- IMF_newdata %>%
  filter(year == 2022) %>%
  select(countryname, average_cost_climatechange, average_cost_explicit) %>%
  rename(
    Category = countryname,
    Value1 = average_cost_climatechange,
    Value2 = average_cost_explicit
  )

top_countries2 <- stacked_data2 %>%
  arrange(desc(Value1 + Value2)) %>%  # Arrange in descending order based on the sum of Value1 and Value2
  head(20)

# Reshape the data
data_long2 <- tidyr::gather(top_countries2, key = "Variable", value = "Value", -Category)

# Create a horizontal stacked bar chart
stacked_barchart_top20_2 <- ggplot(data_long2, aes(y = Category, x = Value, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Fossil Fuel subsidies in the top 20 countries in 2022",
       y = "Country",
       x = "Fossil fuel subsidies",
       fill = "legend") +
  scale_fill_manual(values = c("Value1" = "blue", "Value2" = "red"),
                    name = "Type of Subsidy",
                    labels = c("Value1" = "Climate change subsidy", "Value2" = "Explicit subsidy"))


stacked_barchart_top20_2

```

```{r pressure69}
bottom_countries2 <- stacked_data2 %>%
  group_by(Category) %>%
  arrange(Value1 + Value2) %>%  # Arrange in descending order based on the sum of Value1 and Value2
  head(20)

# Reshape the data
data_long3 <- tidyr::gather(bottom_countries2, key = "Variable", value = "Value", -Category)

# Create a horizontal stacked bar chart
stacked_barchart_top20_3 <- ggplot(data_long3, aes(y = Category, x = Value, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Fossil Fuel subsidies in the top 20 countries in 2022",
       y = "Country",
       x = "Fossil fuel subsidies",
       fill = "legend") +
  scale_fill_manual(values = c("Value1" = "blue", "Value2" = "red"),
                    name = "Type of Subsidy",
                    labels = c("Value1" = "Climate change subsidy", "Value2" = "Explicit subsidy"))


stacked_barchart_top20_3
```



Now, I create the ame bar chart but with the bottom 20 countries
```{r pressure9}
bottom20_data_world <- data_2015_2022 %>%
  group_by(countryname) %>%
  summarize(avg_climatechange_explicit_GDP_country = mean(climatechange_explicit_GDP, na.rm = TRUE)) %>%
  arrange(avg_climatechange_explicit_GDP_country) %>%
  head(20)

horizontalbarchart_bottom20_world <- ggplot(bottom20_data_world) +
  geom_col(aes(x = reorder(countryname, desc(avg_climatechange_explicit_GDP_country)), y = avg_climatechange_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Bottom 20 Countries by Average Climate Change cost as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip()

horizontalbarchart_bottom20_world
```

Now, I look at the differences between explicit and climate change subsidies in the bottom 20 countries in the world in 2022
```{r pressure111}
bottom_countries <- stacked_data %>%
  arrange(Value1 + Value2) %>%  # Arrange in descending order based on the sum of Value1 and Value2
  head(20)

# Reshape the data
data_bottom <- tidyr::gather(bottom_countries, key = "Variable", value = "Value", -Category)

# Create a horizontal stacked bar chart
stacked_barchart_bottom20 <- ggplot(data_bottom, aes(y = Category, x = Value, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Fossil Fuel subsidies in the bottom 20 countries in 2022",
       y = "Country",
       x = "Fossil fuel subsidies",
       fill = "legend") +
  scale_fill_manual(values = c("Value1" = "blue", "Value2" = "red"),
                    name = "Type of Subsidy",
                    labels = c("Value1" = "Climate change subsidy", "Value2" = "Explicit subsidy"))


stacked_barchart_bottom20
```


Now, I look at the 2 bar charts, but on the same scale: that is with a maximum of 24% in order to be able to include Venezuela


```{r pressure0}
horizontalbarchart_top20_world2 <- ggplot(top20_data_world) +
  geom_col(aes(x = reorder(countryname, avg_climatechange_explicit_GDP_country), y = avg_climatechange_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Top 20 Countries by fossil fuel subsidies as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 24))

# Print the modified chart
print(horizontalbarchart_top20_world2)
```

```{r pressureg}
horizontalbarchart_bottom20_world2 <- ggplot(bottom20_data_world) +
  geom_col(aes(x = reorder(countryname, desc(avg_climatechange_explicit_GDP_country)), y = avg_climatechange_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Bottom 20 Countries by fossil fuel subsidies as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 24))

# Print the modified chart
print(horizontalbarchart_bottom20_world2)
```

Now, I look at the trend over the year per region. First, I need to create an aggregate average in the level of fossil fuel subsidies per each region. Then, I can make the graph 
```{r pressuref}
IMF_newdata_avg <- IMF_newdata %>%
  select(year, region, countryname, climatechange_explicit_GDP) %>%
  group_by(year, region) %>%
  summarize(avg_climatechange_explicit_GDP = mean(climatechange_explicit_GDP))

#I make the line chart
linechart_regions <- ggplot(data = IMF_newdata_avg, aes(x = year, y = avg_climatechange_explicit_GDP, group = region, color = region)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c('Green','Yellow', 'Red', 'Orange', 'Blue', 'Brown', 'Purple')) +
  labs(title = "Average Climate Change cost as a share of GDP by Region",
       x = "Year",
       y = "Average Fossil fuels subsidies")

linechart_regions

```

Now, I make the ame line chart, but I create a new region with EEA countries to see if the result is different when not taking into account Cetral Asia. so, the column Europe & Central Asia now does not include EEA countries
```{r pressurefd}
IMF_newdata_newregion <- IMF_newdata %>%
  mutate(region = case_when(
    countryname %in% c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia",
  "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary",
  "Iceland", "Ireland", "Italy", "Latvia", "Lithuania",
  "Luxembourg", "Malta", "Netherlands", "Norway", "Poland", "Portugal",
  "Romania", "Slovak Republic", "Slovenia", "Spain", "Sweden", "Switzerland",
  "United Kingdom") ~ "EEA",
    # Add more conditions if needed
    TRUE ~ region  # Keep the current value if none of the conditions match
  )) 

IMF_newdata_newregion_avg <- IMF_newdata_newregion %>%
  group_by(year, region) %>%
  summarize(avg_climatechange_explicit_GDP = mean(climatechange_explicit_GDP))

linechart_regions_EEA <- ggplot(data = IMF_newdata_newregion_avg, aes(x = year, y = avg_climatechange_explicit_GDP, group = region, color = region)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c('Green','Yellow', 'Red', 'Orange', 'Blue', 'Brown', 'Purple', "Black")) +
  labs(title = "Average Fossil Fuels as a share of GDP by Region",
       x = "Year",
       y = "Average Fossil Fuel subsidies")

linechart_regions_EEA

write.csv(IMF_newdata_newregion_avg, "C:/Users/lionet000/Documents/fossil fuels/IMF_newdata_newregion_avg.csv", row.names = FALSE)
```
Now I look at the 10 countries which deviate the most on average from the mean average for each region across the years 2015-2022
```{r pressured}
#I do so fro Middle East and North Africa
filtered_data_MN <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'Middle East & North Africa')

# Calculate the regional mean and standard deviation for each year
regional_stats_MN <- filtered_data_MN %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_MN <- filtered_data_MN %>%
  left_join(regional_stats_MN, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_MN <- country_deviations_MN %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_MN)

#I make it a plot
outliers_MN <- ggplot(top_countries_avg_deviation_MN, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in Middle East & North Africa (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_MN
```

```{r pressured444}
#I do so for Europe & Central Asia
filtered_data_ECA <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'Europe & central Asia')

# Calculate the regional mean and standard deviation for each year
regional_stats_ECA <- filtered_data_ECA %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_ECA <- filtered_data_ECA %>%
  left_join(regional_stats_ECA, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_ECA <- country_deviations_ECA %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_ECA)

#I make it a plot
outliers_ECA <- ggplot(top_countries_avg_deviation_ECA, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in Europe & Central Asia (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_ECA
```


```{r pressured}
#I do so for East Asia & Pacific
filtered_data_EP <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'East Asia & Pacific')

# Calculate the regional mean and standard deviation for each year
regional_stats_EP <- filtered_data_EP %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_EP <- filtered_data_EP %>%
  left_join(regional_stats_EP, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_EP <- country_deviations_EP %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_EP)

#I make it a plot
outliers_EP <- ggplot(top_countries_avg_deviation_EP, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in East Asia & the Pacific (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_EP
```

```{r pressured}
#I do so for Sub-Saharian Africa
filtered_data_SA <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'Sub-Saharan Africa')

# Calculate the regional mean and standard deviation for each year
regional_stats_SA <- filtered_data_SA %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_SA <- filtered_data_SA %>%
  left_join(regional_stats_SA, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_SA <- country_deviations_SA %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_SA)

#I make it a plot
outliers_SA <- ggplot(top_countries_avg_deviation_SA, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in Sub-Saharian Africa (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_SA
```
```{r pressured}
#I do so for LAti America & the Carribeans
filtered_data_LC <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'Latin America & Caribbean')

# Calculate the regional mean and standard deviation for each year
regional_stats_LC <- filtered_data_LC %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_LC <- filtered_data_LC %>%
  left_join(regional_stats_LC, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_LC <- country_deviations_LC %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_LC)

#I make it a plot
outliers_LC <- ggplot(top_countries_avg_deviation_LC, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in Latin America & Carribean (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_LC
```

```{r pressured}
#I do so for North America
filtered_data_NA <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'North America')

# Calculate the regional mean and standard deviation for each year
regional_stats_NA <- filtered_data_NA %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_NA <- filtered_data_NA %>%
  left_join(regional_stats_NA, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_NA <- country_deviations_NA %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_NA)

#I make it a plot
outliers_NA <- ggplot(top_countries_avg_deviation_NA, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in North America (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_NA
```


```{r pressured}
#I do so for South Asia
filtered_data_SA <- IMF_newdata %>%
  filter(year >= 2015 & year <= 2022, region == 'South Asia')

# Calculate the regional mean and standard deviation for each year
regional_stats_SA <- filtered_data_SA %>%
  group_by(year, region) %>%
  summarize(
    mean_climatechange_explicit_GDP = mean(climatechange_explicit_GDP),
    sd_climatechange_explicit_GDP = sd(climatechange_explicit_GDP)
  )

# Calculate the deviation for each country for each year
country_deviations_SA <- filtered_data_SA %>%
  left_join(regional_stats_SA, by = c("year", "region")) %>%
  group_by(countryname) %>%
  summarize(
    avg_deviation = mean(climatechange_explicit_GDP - mean_climatechange_explicit_GDP),
    direction = ifelse(avg_deviation > 0, "Above", "Below")
  )

top_countries_avg_deviation_SA <- country_deviations_SA %>%
  arrange(desc(abs(avg_deviation))) %>%
  top_n(10, wt = abs(avg_deviation))

# View the resulting table
View(top_countries_avg_deviation_SA)

#I make it a plot
outliers_SA <- ggplot(top_countries_avg_deviation_SA, aes(x = reorder(countryname, -abs(avg_deviation)), y = avg_deviation, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 10 Outlierson average in South Asia (2015-2022)",
       x = "Country",
       y = "Average Deviation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

outliers_SA
```

## MAKING THE GRAPHS - the situation in the EU

First, I create a map and a horizontal bar chart with the values of fossil fuel subsidies as an average etwee 2015 and 2022
```{r pressured}
selected_countries <- c(
  "Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia",
  "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary",
  "Iceland", "Ireland", "Italy", "Latvia", "Lithuania",
  "Luxembourg", "Malta", "Netherlands", "Norway", "Poland", "Portugal",
  "Romania", "Slovak Republic", "Slovenia", "Spain", "Sweden", "Switzerland",
  "United Kingdom"
) # Replace with your desired countries
start_year <- 2015
end_year <- 2022

#Now, I filter the data for selected countries and the specified range of years
filtered_data <- IMF_newdata %>%
  filter(countryname %in% selected_countries, year >= start_year, year <= end_year)

average_data_EEA <- filtered_data %>%
  group_by(countryname) %>%
  summarize(avg_climatechange_explict_GDP_EEA = mean(climatechange_explicit_GDP, na.rm = TRUE))

formap_EU<- average_data_EEA %>%
  select(countryname, avg_climatechange_explict_GDP_EEA) %>%
  mutate(avg_climatechange_explicit_GDP_EEA_round = round(avg_climatechange_explict_GDP_EEA, 1)) %>%
  select(countryname, avg_climatechange_explicit_GDP_EEA_round)

formap_EU %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)

formap_EU
```

```{r pressures}
horizontalbarchart_EEA <- ggplot(average_data_EEA) +
  geom_col(aes(x = reorder(countryname, avg_climatechange_explict_GDP_EEA), y = avg_climatechange_explict_GDP_EEA), fill = "blue", width = 0.6) +
  labs(title = "Average Climate Change cost as a share of GDP (2015 - 2022) - EEA",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip() 

horizontalbarchart_EEA

```
Now, I create the same map and bar chart, but for the year 2022
```{r pressurea}
formap_EU_2022 <- IMF_newdata %>%
  filter(countryname %in% selected_countries, year== 2022) %>% 
  select(countryname, climatechange_explicit_GDP) %>%
  mutate(climatechange_explicit_GDP = round(climatechange_explicit_GDP, 1))

formap_EU_2022 %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)

formap_EU_2022
```

```{r pressureA}
horizontalbarchart_EEA_2022 <- ggplot(formap_EU_2022, aes(x = climatechange_explicit_GDP, y = reorder(countryname, climatechange_explicit_GDP))) +
  geom_col(fill = "blue", width = 0.6) +
  labs(title = "Fossil fuel subsidies as a share of GDP in EEA in 2022",
       x = "Average % fossil fuel subsidies",
       y = "Country") +
  theme_minimal()

# Print the bar chart
horizontalbarchart_EEA_2022
```

Now, I make a bar chart with the comparison of money spent for explicit subsidies ad climate change subsidies
```{r pressureBB}
stacked_data_EU <- filtered_data %>%
  filter(year == 2022) %>%
  select(countryname, climatechange_GDP, explicitsubidies_GDP) %>%
  rename(
    Category = countryname,
    Value1 = climatechange_GDP,
    Value2 = explicitsubidies_GDP
    ) %>%
  group_by(Category) %>%
  arrange(Value1 + Value2) %>%
  head(31)

data_long_EU <- tidyr::gather(stacked_data_EU, key = "Variable", value = "Value", -Category)

# Create a horizontal stacked bar chart
stacked_barchart_EU <- ggplot(data_long_EU, aes(x = Value, y = Category, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Fossil Fuel subsidies in the EU in 2022",
       y = "Country",
       x = "Fossil fuel subsidies",
       fill = "legend") +
  scale_fill_manual(values = c("Value1" = "blue", "Value2" = "red"),
                    name = "Type of Subsidy",
                    labels = c("Value1" = "Climate change subsidy", "Value2" = "Explicit subsidy"))


stacked_barchart_EU
```

Now, I look at the trend across years for selected EEA countries. 
First, I look at the top UE countries

```{r pressureR}
selected_countries_new <- c(
  "Bulgaria", "Poland", "Czechia", "Estonia", "Romania", "Hungary", "Lithuania"
)

filtered_data_new <- IMF_newdata %>%
  filter(countryname %in% selected_countries_new, year >= start_year, year <= end_year)


linechart_EU <- ggplot(data = filtered_data_new, aes(x = year, y = climatechange_explicit_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  labs(title = "Fossil fuel subsidies as a share of GDP - top EEA countries",
       x = "Year",
       y = "% Climate Change and explicit subsidies")

linechart_EU
```

Now, I do the same for the countries with average subsidies in the EU
```{r pressureJJ}
selected_countries_new2 <- c(
  "Sweden", "Netherlands", "Germany", "Denmark", "Greece", "Latvia", "Croatia"
)

filtered_data_new2 <- IMF_newdata %>%
  filter(countryname %in% selected_countries_new2, year >= start_year, year <= end_year)


linechart_EU_new2 <- ggplot(data = filtered_data_new2, aes(x = year, y = climatechange_explicit_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  labs(title = "Fossil fuel subsidies as a share of GDP - mean EEA countries",
       x = "Year",
       y = "% Climate Change and explicit subsidies")

linechart_EU_new2
```

```{r pressureO}
selected_countries_new3 <- c(
  "Iceland", "Norway", "Italy", "France", "Spain", "Belgium", "United Kingdom", "'Finland", "Austria"
)

filtered_data_new3 <- IMF_newdata %>%
  filter(countryname %in% selected_countries_new3, year >= start_year, year <= end_year)


linechart_EU_new3 <- ggplot(data = filtered_data_new3, aes(x = year, y = climatechange_explicit_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  labs(title = "Fossil fuel subsidies as a share of GDP - bottom EEA countries",
       x = "Year",
       y = "% Climate Change and explicit subsidies")

linechart_EU_new3
```

Now, I create a map with the avergae cost of explicit+climate change subsidies and one with the cot of climatechange subidies
```{r pressureKK}
formap_cost<- IMF_newdata %>%
  filter(year== 2022) %>% 
  select(countrycode, average_cost_explicit_climatechange) %>%
   mutate(average_cost_explicit_climatechange = round(average_cost_explicit_climatechange, 1))

#I copy the data to the clipboard so that I can copy them directly in datawrapper
formap_cost %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)
```

```{r pressureKKK}
formap_cost_climate<- IMF_newdata %>%
  filter(year== 2022) %>% 
  select(countrycode, average_cost_climatechange) %>%
   mutate(average_cost_climatechange = round(average_cost_climatechange, 1))

#I copy the data to the clipboard so that I can copy them directly in datawrapper
formap_cost_climate %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)
```

## MAKING THE GRAPHS PART 2 - Now I do the graphs only for the global warming subsidy
The general situation

I make a map with the values of 2022
```{r pressureK}
formap<- IMF_newdata %>%
  filter(year== 2022) %>% 
  select(countrycode, climatechange_GDP) %>%
  mutate(climatechange_GDP = round(climatechange_GDP, 1))

#I copy the data to the clipboard so that I can copy them directly in datawrapper
formap %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)
```

I make a line chart to look at the trend over the years across various regions
```{r pressure}
IMF_newdata_avg_CC <- IMF_newdata %>%
  group_by(year, region) %>%
  summarize(avg_climatechange_GDP = mean(climatechange_GDP))

#I make the line chart
linechart_regions_CC <- ggplot(data = IMF_newdata_avg_CC, aes(x = year, y = avg_climatechange_GDP, group = region, color = region)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c('Green','Yellow', 'Red', 'Orange', 'Blue', 'Brown', 'Purple')) +
  labs(title = "Average Climate Change cost as a share of GDP by Region",
       x = "Year",
       y = "Average % Climate Change cost")

linechart_regions_CC
```

Now, I look at the top 20 countries and the bottom 20 coutries

```{r pressureFFJ}
start_year <- 2015
end_year <- 2022

filtered_data_CC <- IMF_newdata %>%
  filter(year >= start_year, year <= end_year) 

top20_data_CC <- filtered_data %>%
  group_by(countrycode) %>%
  summarize(avg_climatechange_GDP_country = mean(climatechange_GDP, na.rm = TRUE)) %>%
  arrange(desc(avg_climatechange_GDP_country)) %>%
  head(20)

horizontalbarchart_top20_CC <- ggplot(top20_data_CC) +
  geom_col(aes(x = reorder(countrycode, avg_climatechange_GDP_country), y = avg_climatechange_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Top 20 Countries by Average Climate Change cost as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip()

horizontalbarchart_top20_CC
```

```{r pressureB}
bottom20_data_CC <- filtered_data_CC %>%
  group_by(countrycode) %>%
  summarize(avg_climatechange_GDP_country = mean(climatechange_GDP, na.rm = TRUE)) %>%
  arrange(avg_climatechange_GDP_country) %>%
  head(20)

horizontalbarchart_bottom20_CC <- ggplot(bottom20_data_CC) +
  geom_col(aes(x = reorder(countrycode, desc(avg_climatechange_GDP_country)), y = avg_climatechange_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Bottom 20 Countries by Average Climate Change cost as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip()

horizontalbarchart_bottom20_CC
```

The situation in the EU

Now, I create an horizontal bar chart for EEA countries + Switzerland and UK (Liechtenstein is not included as it is not present in the dataset) First, I select the countries and the range of years

```{r pressureV}
average_data_EEA_CC <- filtered_data %>%
  group_by(countryname) %>%
  summarize(avg_climatechange_GDP_EEA = mean(climatechange_GDP, na.rm = TRUE))

horizontalbarchart_EEA_CC <- ggplot(average_data_EEA_CC) +
  geom_col(aes(x = reorder(countryname, avg_climatechange_GDP_EEA), y = avg_climatechange_GDP_EEA), fill = "blue", width = 0.6) +
  labs(title = "Average Climate Change cost as a share of GDP (2015 - 2022) - EEA",
       x = "Country",
       y = "Average % Climate Change cost") +
  coord_flip() 

horizontalbarchart_EEA_CC
```
```{r pressureC}
formap_EU_CC<- average_data_EEA_CC %>%
  select(countryname, avg_climatechange_GDP_EEA) %>%
  mutate(avg_climatechange_GDP_EEA = round(avg_climatechange_GDP_EEA, 1))

formap_EU

#I copy the data to the clipboard so that I can copy them directly in datawrapper
formap_EU %>% write.table( "clipboard", sep="\t", dec=",", row.names=FALSE, col.names=TRUE)
```
Now, I create line charts with selected EU countries: one with the top countries, pone with the average countries and one with the countries in the bottom

I create a line graph to see how the situation changed over the years for the EEA countries that were in the middle in the horizontal bar chart

```{r pressureX}
selected_countries_CC <- c(
  "Austria", "Belgium", "France", "Italy", "Netherlands", "Spain","United Kingdom"
  )

filtered_data_EU_CC <- IMF_newdata %>%
  filter(countryname %in% selected_countries_CC, year >= start_year, year <= end_year)


linechart_EU_CC <- ggplot(data = filtered_data_EU_CC, aes(x = year, y = climatechange_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c('Green','Yellow', 'Red', 'Orange', 'Blue', 'Brown', 'Purple')) +
  labs(title = "Climate Change cost as a share of GDP - mean EEA countries",
       x = "Country",
       y = "% Climate Change cost")

linechart_EU_CC
```

I do the same with the countries with the highest shares of climatechange_GDP
```{r pressureZ}
selected_countries_CC2 <- c(
  "Bulgaria", "Poland", "Czechia", "Slovak Republic", "Romania", "Hungary", "Greece", "Lithuania","Latvia", "Germany"
)

filtered_data_EU_CC2 <- IMF_newdata %>%
  filter(countryname %in% selected_countries_CC2, year >= start_year, year <= end_year)


linechart_EU_CC2 <- ggplot(data = filtered_data_EU_CC2, aes(x = year, y = climatechange_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  labs(title = "Climate Change cost as a share of GDP - top EEA countries",
       x = "Year",
       y = "% Climate Change cost")

linechart_EU_CC2
```

Finally, I do the same with the countries with the lowest shares of climatechange_GDP

```{r pressureL}
selected_countries_CC3 <- c(
  "Iceland", "Norway", "Switzerland", "Sweden", "Denmark", "Ireland"
)

filtered_data_EU_CC3 <- IMF_newdata %>%
  filter(countryname %in% selected_countries_CC3, year >= start_year, year <= end_year)


linechart_EU_CC3 <- ggplot(data = filtered_data_EU_CC3, aes(x = year, y = climatechange_GDP, group = countryname, color = countryname)) +
  geom_line() +
  geom_point() +
  labs(title = "Climate Change cost as a share of GDP - bottom EEA countries",
       x = "Year",
       y = "% Climate Change cost")

linechart_EU_CC3
```




I look only at the explicit subsidies. I look at which countries have the lowest and highest subsidies in the world. 
```{r pressureL}
start_year <- 2015
end_year <- 2022

data_2015_2022 <- IMF_newdata %>%
  filter(year >= start_year, year <= end_year) 

top20_data_explicit <- data_2015_2022 %>%
  group_by(countryname) %>%
  summarize(avg_explicit_GDP_country = mean(explicitsubidies_GDP, na.rm = TRUE)) %>%
  arrange(desc(avg_explicit_GDP_country)) %>%
  head(20)

horizontalbarchart_top20_explicit <- ggplot(top20_data_explicit) +
  geom_col(aes(x = reorder(countryname, avg_explicit_GDP_country), y = avg_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Top 20 Countries by explicit subsidies as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % explicit subsidies") +
  coord_flip()

horizontalbarchart_top20_explicit
```

```{r pressureL}
bottom20_data_explicit <- data_2015_2022 %>%
  group_by(countryname) %>%
  summarize(avg_explicit_GDP_country = mean(explicitsubidies_GDP, na.rm = TRUE)) %>%
  arrange(avg_explicit_GDP_country) %>%
  head(20)

horizontalbarchart_bottom20_explicit <- ggplot(bottom20_data_explicit) +
  geom_col(aes(x = reorder(countryname, desc(avg_explicit_GDP_country)), y = avg_explicit_GDP_country), fill = "blue", width = 0.6) +
  labs(title = "Bottom 20 Countries by explicit subdisidies as a share of GDP (2015-2022)",
       x = "Country",
       y = "Average % explicit subsidies Change cost") +
  coord_flip()

horizontalbarchart_bottom20_explicit
```


Now, I do the same with the EEA
```{r pressureL}
average_data_EEA_explicit <- filtered_data %>%
  group_by(countryname) %>%
  summarize(avg_explict_GDP_EEA = mean(explicitsubidies_GDP, na.rm = TRUE))

horizontalbarchart_EEA_explicit <- ggplot(average_data_EEA_explicit) +
  geom_col(aes(x = reorder(countryname, avg_explict_GDP_EEA), y = avg_explict_GDP_EEA), fill = "blue", width = 0.6) +
  labs(title = "Average explicit subsidies as a share of GDP (2015 - 2022) - EEA",
       x = "Country",
       y = "Average % explicit subsidies") +
  coord_flip() 

horizontalbarchart_EEA_explicit
```

```{r pressureL}
region_to_check <- "Europe & Central Asia"

# Using subset function
countries_in_region <- unique(subset(IMF_newdata, region == region_to_check)$countryname)

# Using indexing based on logical condition
countries_in_region <- IMF_newdata$countryname[IMF_newdata$region == region_to_check]

# Print the result
print(countries_in_region)

unique_regions_countries <- unique(IMF_newdata[, c("region", "countryname")])
print(unique_regions_countries)
```